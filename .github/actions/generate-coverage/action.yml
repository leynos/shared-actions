name: Generate coverage
description: Run test coverage for Rust, Python and mixed Rust and Python projects
inputs:
  features:
    description: Cargo features to enable
    required: false
    type: string
  with-default-features:
    description: Enable default features
    required: false
    type: boolean
    default: true
  output-path:
    description: Output file path
    required: true
    type: string
  format:
    description: Coverage format
    required: false
    type: string
    default: cobertura
  with-ratchet:
    description: Fail if coverage falls below the stored baseline
    required: false
    type: boolean
    default: false
  baseline-rust-file:
    description: Path to store the Rust coverage baseline
    required: false
    default: .coverage-baseline.rust
  baseline-python-file:
    description: Path to store the Python coverage baseline
    required: false
    default: .coverage-baseline.python
outputs:
  file:
    description: Path to the generated coverage file
    value: ${{ steps.out.outputs.file }}
  format:
    description: Format of the coverage file
    value: ${{ steps.out.outputs.format }}
  lang:
    description: Detected project language
    value: ${{ steps.detect.outputs.lang }}
runs:
  using: composite
  steps:
    - id: detect
      run: uv run --script scripts/generate_coverage/detect.py
      shell: bash
    - name: Restore Rust baseline
      if: inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'rust' || steps.detect.outputs.lang == 'mixed')
      uses: actions/cache@v4
      with:
        path: ${{ inputs.baseline-rust-file }}
        key: ratchet-baseline-rust-${{ runner.os }}
    - name: Restore Python baseline
      if: inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed')
      uses: actions/cache@v4
      with:
        path: ${{ inputs.baseline-python-file }}
        key: ratchet-baseline-python-${{ runner.os }}
    - id: rust
      if: steps.detect.outputs.lang == 'rust' || steps.detect.outputs.lang == 'mixed'
      run: uv run --script scripts/generate_coverage/run_rust.py
      env:
        DETECTED_LANG: ${{ steps.detect.outputs.lang }}
        DETECTED_FMT: ${{ steps.detect.outputs.fmt }}
      shell: bash
    - name: Ratchet Rust coverage
      if: inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'rust' || steps.detect.outputs.lang == 'mixed')
      run: uv run --script scripts/ratchet_coverage/ratchet_coverage.py
      env:
        INPUT_BASELINE_FILE: ${{ inputs.baseline-rust-file }}
        CURRENT_PERCENT: ${{ steps.rust.outputs.percent }}
      shell: bash
    - name: Save Rust baseline
      if: success() && inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'rust' || steps.detect.outputs.lang == 'mixed')
      uses: actions/cache@v4
      with:
        path: ${{ inputs.baseline-rust-file }}
        key: ratchet-baseline-rust-${{ runner.os }}
    - name: Install uv and set the python version
      if: steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed'
      uses: astral-sh/setup-uv@v5

    - name: Cache Python deps
      if: steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed'
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-py-deps-${{ hashfiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-py-deps-

    - name: Install slipcover and pytest
      if: steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed'
      run: uv pip install --system slipcover pytest
      shell: bash

    - id: python
      if: steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed'
      run: uv run --script scripts/generate_coverage/run_python.py
      env:
        DETECTED_LANG: ${{ steps.detect.outputs.lang }}
        DETECTED_FMT: ${{ steps.detect.outputs.fmt }}
      shell: bash
    - name: Ratchet Python coverage
      if: inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed')
      run: uv run --script scripts/ratchet_coverage/ratchet_coverage.py
      env:
        INPUT_BASELINE_FILE: ${{ inputs.baseline-python-file }}
        CURRENT_PERCENT: ${{ steps.python.outputs.percent }}
      shell: bash
    - name: Save Python baseline
      if: success() && inputs.with-ratchet == 'true' && (steps.detect.outputs.lang == 'python' || steps.detect.outputs.lang == 'mixed')
      uses: actions/cache@v4
      with:
        path: ${{ inputs.baseline-python-file }}
        key: ratchet-baseline-python-${{ runner.os }}
    - if: steps.detect.outputs.lang == 'mixed'
      run: uv run --script scripts/generate_coverage/merge_cobertura.py
      env:
        RUST_FILE: ${{ steps.rust.outputs.file }}
        PYTHON_FILE: ${{ steps.python.outputs.file }}
        OUTPUT_PATH: ${{ inputs.output-path }}
      shell: bash
    - id: out
      run: uv run --script scripts/generate_coverage/set_outputs.py
      env:
        DETECTED_FMT: ${{ steps.detect.outputs.fmt }}
      shell: bash
