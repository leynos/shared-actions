name: Test export-cargo-metadata
on:
  workflow_dispatch:
  pull_request:

jobs:
  test-export-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Export Cargo metadata
        id: metadata
        uses: ./.github/actions/export-cargo-metadata
        with:
          manifest-path: rust-toy-app/Cargo.toml
          fields: name,version,bin-name,description

      - name: Verify outputs
        run: |
          echo "name=${{ steps.metadata.outputs.name }}"
          echo "version=${{ steps.metadata.outputs.version }}"
          echo "bin-name=${{ steps.metadata.outputs.bin-name }}"
          # Verify name is not empty
          [[ -n "${{ steps.metadata.outputs.name }}" ]]
          # Verify version matches semver pattern
          [[ "${{ steps.metadata.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]

  test-export-metadata-env-overrides:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure env overrides
        id: config
        run: |
          # Use INPUT_* env vars (set by act or external runner) if provided, otherwise defaults
          {
            echo "fields=${INPUT_FIELDS:-name}"
          } >> "$GITHUB_OUTPUT"

      - name: Export Cargo metadata with env overrides
        id: metadata
        uses: ./.github/actions/export-cargo-metadata
        with:
          manifest-path: rust-toy-app/Cargo.toml
          fields: ${{ steps.config.outputs.fields }}

      - name: Verify outputs
        run: |
          echo "name=${{ steps.metadata.outputs.name }}"
          echo "version=${{ steps.metadata.outputs.version }}"
          [[ -n "${{ steps.metadata.outputs.name }}" ]]
          [[ -z "${{ steps.metadata.outputs.version }}" ]]
