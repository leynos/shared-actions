# Setup Rust

Install the Rust toolchain and cache your build dependencies. Optionally
install PostgreSQL system libraries for crates that require them.

## Inputs

| Name | Description | Required | Default |
| --- | --- | --- | --- |
| install-postgres-deps | Install PostgreSQL system dependencies | no | `false` |
| BUILD_PROFILE | Build profile used for caching | no | `release` |

## Outputs

None

## Example

```yaml
uses: ./.github/actions/setup-rust@v1
  with:
    install-postgres-deps: true
```

When `install-postgres-deps` is enabled, the action installs PostgreSQL
client libraries via the package manager for the runner OS. On Linux,
it uses `apt` (`libpq-dev`). On Windows, Chocolatey installs
`postgresql17` and exposes its headers and import libraries through
`PG_INCLUDE` and `PG_LIB` environment variables.

SQLite is also available on Windows. The action sets up an MSYS2
environment and installs the `mingw-w64-x86_64-sqlite3` package so the
static library and headers are available when compiling crates that
depend on SQLite.

```yaml
      # Bring in MSYS2 plus the MinGW build of SQLite
      - name: Set up MSYS2 and SQLite
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-sqlite3       # ships libsqlite3.a + headers

      # Build inside the MSYS2 shell so the linker sees /mingw64/lib
      - name: Build
        shell: msys2 {0}
        run: cargo build --workspace --all-targets --verbose
```

## Caching

This action caches `~/.cargo/registry`, `~/.cargo/git` and the build output in
`target/$BUILD_PROFILE` using
[actions/cache](https://github.com/actions/cache). The cache key combines the
operating system, the `BUILD_PROFILE` environment variable and checksums of
`rust-toolchain.toml` and any `Cargo.lock` files.

The cache is restored when this step runs and is saved **after the entire job**
finishes. Any files generated by subsequent build steps therefore become part of
the cached directories.

### Requirements

- Set the `BUILD_PROFILE` environment variable (`debug` or `release`) before
  invoking the action so that the cache key is deterministic.

### Extent and limitations

- GitHub limits the total cache size to 5Â GB per repository and OS, so old
  entries may be evicted.
- Caches are scoped to the runner OS; Linux, macOS, and Windows caches are
  independent.
- The cache is best-effort: if the key changes or the cache is evicted, the
  build will proceed without cached artifacts.

### Effective use

- Keep `rust-toolchain.toml` and `Cargo.lock` files checked in to ensure stable
  cache keys.
- Set `BUILD_PROFILE` consistently across jobs. For most CI runs, `release` is a
  good choice.


Release history is available in [CHANGELOG](CHANGELOG.md).
