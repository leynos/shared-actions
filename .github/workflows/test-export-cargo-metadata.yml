name: Test export-cargo-metadata
on:
  workflow_dispatch:
  pull_request:

jobs:
  test-export-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Export Cargo metadata
        id: metadata
        uses: ./.github/actions/export-cargo-metadata
        with:
          manifest-path: rust-toy-app/Cargo.toml
          fields: name,version,bin-name,description

      - name: Verify outputs
        run: |
          echo "name=${{ steps.metadata.outputs.name }}"
          echo "version=${{ steps.metadata.outputs.version }}"
          echo "bin-name=${{ steps.metadata.outputs.bin-name }}"
          # Verify name is not empty
          [[ -n "${{ steps.metadata.outputs.name }}" ]]
          # Verify version matches semver pattern
          [[ "${{ steps.metadata.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]

  test-export-metadata-env-overrides:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Configure env overrides
        run: |
          if [[ "${ACT:-}" != "true" ]]; then
            echo "INPUT_FIELDS=name" >> "$GITHUB_ENV"
          fi

      - name: Export Cargo metadata with env overrides
        id: metadata
        uses: ./.github/actions/export-cargo-metadata
        with:
          manifest-path: rust-toy-app/Cargo.toml
          fields: name,version

      - name: Verify outputs
        run: |
          echo "name=${{ steps.metadata.outputs.name }}"
          echo "version=${{ steps.metadata.outputs.version }}"
          [[ -n "${{ steps.metadata.outputs.name }}" ]]
          [[ -z "${{ steps.metadata.outputs.version }}" ]]
