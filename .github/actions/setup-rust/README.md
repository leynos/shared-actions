# Setup Rust

Install the Rust toolchain and cache your build dependencies. Optionally
install PostgreSQL and SQLite system libraries for crates that require
them, and set up macOS or OpenBSD cross-compilers.

## Inputs

| Name | Description | Required | Default |
| --- | --- | --- | --- |
| toolchain | Rust toolchain to install (e.g., `stable`, `nightly`, `1.70.0`). If omitted, uses `.rust-toolchain.toml` when present, otherwise `stable`. | no | _see description_ |
| install-postgres-deps | Install PostgreSQL system dependencies | no | `false` |
| workspaces | Cargo workspace to target mappings for `Swatinem/rust-cache`. Each non-empty line must use the format `workspace -> target`; leave empty to cache the default `. -> target`. | no | _(empty)_ (defaults to `. -> target`) |
| install-sqlite-deps | Install SQLite dev libraries (Windows) | no | `false` |
| use-sccache | Enable sccache for non-release runs | no | `true` |
| with-darwin | Install macOS cross build toolchain | no | `false` |
| darwin-sdk-version | macOS SDK version for osxcross | no | `12.3` |
| with-openbsd | Build OpenBSD std library for cross-compilation | no | `false` |
| openbsd-nightly | Pinned nightly Rust for OpenBSD | no | `nightly-2025-07-20` |

## Outputs

None

## Example

```yaml
uses: ./.github/actions/setup-rust@v1
  with:
    toolchain: 'nightly'
    install-postgres-deps: 'true'
    install-sqlite-deps: 'true'
    use-sccache: 'false'
    with-darwin: true
    with-openbsd: true
```

When `install-postgres-deps` is enabled, the action installs PostgreSQL
client libraries via the package manager for the runner OS. On Linux,
it uses `apt` (`libpq-dev`). On Windows, Chocolatey installs
`postgresql17` and exposes its headers and import libraries through
`PG_INCLUDE` and `PG_LIB` environment variables.

When `install-sqlite-deps` is enabled, the action installs SQLite
development files using MSYS2 on Windows.

SQLite support on Windows is enabled by setting up an MSYS2 environment
with the MinGW toolchain and the `mingw-w64-x86_64-sqlite3` package,
so the static library and headers are available when compiling crates that
depend on SQLite.

When `with-darwin` is enabled, the action installs the osxcross toolchain on
Linux so that Rust crates can be cross-compiled for macOS. The SDK version can
be configured via the `darwin-sdk-version` input and defaults to `12.3`. The
`x86_64-apple-darwin` and `aarch64-apple-darwin` Rust targets are installed so
that Cargo can produce macOS binaries.

When `with-openbsd` is enabled, the action installs the nightly toolchain
specified by the `openbsd-nightly` input (default `nightly-2025-07-20`), builds
the OpenBSD standard library from the Rust source tree, installs it into
`rustup`, and caches the result so that the `x86_64-unknown-openbsd` target is
readily available on later runs.

```yaml
      # Bring in MSYS2 plus the MinGW build of SQLite
      - name: Install MSYS2 toolchain and SQLite
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-sqlite3       # ships libsqlite3.a + headers

      # Build inside the MSYS2 shell so the linker sees /mingw64/lib
      - name: Build
        shell: msys2 {0}
        run: cargo build --workspace --all-targets --verbose
```

## Caching

This action caches `~/.cargo` and workspace `target` directories using
[Swatinem/rust-cache](https://github.com/Swatinem/rust-cache). The optional
`workspaces` input is forwarded to that action, enabling per-workspace cache
configuration. The cache is restored when the step runs and is saved **after
the entire job** finishes, so any files generated by subsequent build steps
become part of the cached directories. If the input is left empty, the action
uses the default mapping `. -> target` from `Swatinem/rust-cache`.

Example:

```yaml
  - name: Cache Rust dependencies
    uses: Swatinem/rust-cache@54e2af0a8339c0435fa1de94002eab349a2f15ef
    with:
      workspaces: |
        . -> target
        crates/api -> target
        crates/cli -> target
```

When the workflow is not triggered by a `release` event and `use-sccache` is
enabled, the action also runs [sccache](https://github.com/mozilla/sccache) to
cache compiler output. It sets `SCCACHE_GHA_ENABLED=true` and
`RUSTC_WRAPPER=sccache` so subsequent build steps benefit from the cache. The
compiled objects are stored in `~/.cache/sccache` and cached with a **separate
cache key** from the directories above. This directory holds the sccache cache
space and does not share data with the Rust dependency cache; the sccache step
itself uses
`mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad`,
pinned to a specific commit for reproducibility.

### Extent and limitations

- GitHub limits the total cache size to 5Â GB per repository and OS, so old
  entries may be evicted.
- Caches are scoped to the runner OS; Linux, macOS, and Windows caches are
  independent.
- The cache is best-effort: if the key changes or the cache is evicted, the
  build will proceed without cached artifacts.

### Effective use

- Keep `rust-toolchain.toml` and `Cargo.lock` files checked in to ensure stable
  cache keys.

Release history is available in [CHANGELOG](CHANGELOG.md).
