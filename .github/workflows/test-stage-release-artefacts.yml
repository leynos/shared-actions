name: Test stage-release-artefacts
on:
  workflow_dispatch:
  pull_request:

jobs:
  test-stage-artefacts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Create test artefacts
        run: |
          if [[ "${ACT:-}" == "true" ]]; then
            workspace="${RUNNER_TEMP}/stage-workspace"
          else
            workspace="${GITHUB_WORKSPACE}"
          fi
          mkdir -p "${workspace}/target/release"
          echo "test binary content" > "${workspace}/target/release/test-app"
          chmod +x "${workspace}/target/release/test-app"
          echo "test man page" > "${workspace}/target/release/test-app.1"
          echo "TEST_WORKSPACE=${workspace}" >> "$GITHUB_ENV"

      - name: Create staging config
        run: |
          cat > "${TEST_WORKSPACE}/test-staging.toml" << 'EOF'
          [common]
          bin_name = "test-app"
          dist_dir = "dist"
          checksum_algorithm = "sha256"

          [[common.artefacts]]
          source = "target/release/{bin_name}"
          output = "binary_path"

          [[common.artefacts]]
          source = "target/release/{bin_name}.1"
          output = "man_path"
          required = false

          [targets.linux-x86_64]
          platform = "linux"
          arch = "x86_64"
          target = "x86_64-unknown-linux-gnu"
          EOF

      - name: Stage release artefacts
        id: stage
        uses: ./.github/actions/stage-release-artefacts
        env:
          GITHUB_WORKSPACE: ${{ env.TEST_WORKSPACE }}
        with:
          config-file: ${{ env.TEST_WORKSPACE }}/test-staging.toml
          target: linux-x86_64

      - name: Verify outputs
        run: |
          echo "artifact-dir=${{ steps.stage.outputs.artifact-dir }}"
          echo "staged-files=${{ steps.stage.outputs.staged-files }}"
          # Verify staging directory exists
          [[ -d "${{ steps.stage.outputs.artifact-dir }}" ]]
          # Verify binary was staged
          [[ -f "${{ steps.stage.outputs.binary-path }}" ]]
          # Verify checksum sidecar was created
          [[ -f "${{ steps.stage.outputs.binary-path }}.sha256" ]]
