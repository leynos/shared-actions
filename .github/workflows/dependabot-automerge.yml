name: Dependabot auto-merge

on:
  workflow_call:
    inputs:
      required-label:
        type: string
        default: dependencies
      merge-method:
        type: string
        default: squash
      dry-run:
        type: boolean
        default: false
      pull-request-number:
        type: number
        required: false
      repository:
        type: string
        required: false
    secrets:
      github-token:
        required: false

jobs:
  automerge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
    steps:
      - name: Resolve workflow source
        id: workflow-source
        shell: bash
        env:
          WORKFLOW_REF: ${{ github.workflow_ref }}
          WORKFLOW_SHA: ${{ github.workflow_sha }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
        run: |
          set -euo pipefail
          workspace="${GITHUB_WORKSPACE:-$PWD}"
          if [[ "${ACT:-}" == "true" ]]; then
            echo "checkout=false" >> "${GITHUB_OUTPUT}"
            echo "workflow_dir=${workspace}" >> "${GITHUB_OUTPUT}"
            echo "repo=${REPO}" >> "${GITHUB_OUTPUT}"
            echo "ref=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          if [[ -n "${WORKFLOW_SHA}" ]]; then
            repo="${WORKFLOW_REF%%/.github/workflows/*}"
            ref="${WORKFLOW_SHA}"
          elif [[ -n "${WORKFLOW_REF}" ]]; then
            repo="${WORKFLOW_REF%%/.github/workflows/*}"
            ref="${WORKFLOW_REF##*@}"
          else
            repo="${REPO}"
            ref="${REF}"
          fi
          echo "checkout=true" >> "${GITHUB_OUTPUT}"
          echo "workflow_dir=${workspace}/workflow-src" >> "${GITHUB_OUTPUT}"
          echo "repo=${repo}" >> "${GITHUB_OUTPUT}"
          echo "ref=${ref}" >> "${GITHUB_OUTPUT}"
      - name: Debug workflow source
        shell: bash
        run: |
          set -euo pipefail
          echo "workflow repo: ${{ steps.workflow-source.outputs.repo }}"
          echo "workflow ref: ${{ steps.workflow-source.outputs.ref }}"
          echo "workflow dir: ${{ steps.workflow-source.outputs.workflow_dir }}"
      - name: Checkout workflow repository
        if: ${{ steps.workflow-source.outputs.checkout == 'true' }}
        # v4
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          repository: ${{ steps.workflow-source.outputs.repo }}
          ref: ${{ steps.workflow-source.outputs.ref }}
          path: workflow-src
          fetch-depth: 0
      - name: Verify workflow checkout
        if: ${{ steps.workflow-source.outputs.checkout == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          workflow_dir="${{ steps.workflow-source.outputs.workflow_dir }}"
          script_path="${workflow_dir}/workflow_scripts/dependabot_automerge.py"
          if [[ ! -f "${script_path}" ]]; then
            echo "Missing ${script_path} after checkout."
            echo "Checked-out commit:"
            git -C "${workflow_dir}" rev-parse HEAD
            echo "Workflow directory contents:"
            ls -la "${workflow_dir}"
            exit 1
          fi
      - name: Install uv (act)
        if: ${{ env.ACT == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade --break-system-packages uv
      - name: Setup uv
        if: ${{ env.ACT != 'true' }}
        # v6.4.3
        uses: astral-sh/setup-uv@e92bafb6253dcd438e0484186d7669ea7a8ca1cc
        with:
          python-version: '3.13'
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock
            **/workflow_scripts/*.py
      - name: Run Dependabot auto-merge
        shell: bash
        env:
          INPUT_GITHUB_TOKEN: ${{ secrets.github-token || github.token }}
          INPUT_REQUIRED_LABEL: ${{ inputs.required-label }}
          INPUT_MERGE_METHOD: ${{ inputs.merge-method }}
          INPUT_DRY_RUN: ${{ inputs.dry-run }}
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.pull-request-number }}" ]]; then
            export INPUT_PULL_REQUEST_NUMBER="${{ inputs.pull-request-number }}"
          fi
          if [[ -n "${{ inputs.repository }}" ]]; then
            export INPUT_REPOSITORY="${{ inputs.repository }}"
          fi
          if [[ "${ACT:-}" == "true" ]]; then
            export UV_PROJECT_ENVIRONMENT="/tmp/uv-project"
            export UV_CACHE_DIR="/tmp/uv-cache"
          fi
          uv run --script "${{ steps.workflow-source.outputs.workflow_dir }}/workflow_scripts/dependabot_automerge.py"
