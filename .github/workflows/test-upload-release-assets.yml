name: Test upload-release-assets
on:
  workflow_dispatch:
  pull_request:

jobs:
  test-upload-assets-dry-run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create test dist directory
        id: create-dist
        uses: ./.github/actions/create-test-dist

      - name: Export TEST_DIST_DIR
        run: echo "TEST_DIST_DIR=${{ steps.create-dist.outputs.dist-dir }}" >> "$GITHUB_ENV"

      - name: Upload release assets (dry-run)
        id: upload
        uses: ./.github/actions/upload-release-assets
        with:
          release-tag: v1.0.0
          bin-name: test-app
          dist-dir: ${{ env.TEST_DIST_DIR }}
          dry-run: "true"

      - name: Verify outputs
        run: |
          echo "uploaded-count=${{ steps.upload.outputs.uploaded-count }}"
          echo "upload-error=${{ steps.upload.outputs.upload-error }}"
          # Verify dry-run processed assets
          [[ "${{ steps.upload.outputs.uploaded-count }}" -gt 0 ]]
          [[ "${{ steps.upload.outputs.upload-error }}" == "false" ]]

  test-upload-assets-env-overrides:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create test dist directory
        id: create-dist
        uses: ./.github/actions/create-test-dist

      - name: Configure env overrides
        id: setup
        run: |
          dist_dir="${{ steps.create-dist.outputs.dist-dir }}"
          # Use INPUT_* env vars (set by act or external runner) if provided, otherwise defaults
          {
            echo "TEST_DIST_DIR=${dist_dir}"
          } >> "$GITHUB_ENV"
          {
            echo "release_tag=${INPUT_RELEASE_TAG:-v9.9.9}"
            echo "bin_name=${INPUT_BIN_NAME:-test-app}"
            echo "dist_dir=${INPUT_DIST_DIR:-${dist_dir}}"
            echo "dry_run=${INPUT_DRY_RUN:-true}"
          } >> "$GITHUB_OUTPUT"

      - name: Upload release assets with env overrides (dry-run)
        id: upload
        uses: ./.github/actions/upload-release-assets
        with:
          release-tag: ${{ steps.setup.outputs.release_tag }}
          bin-name: ${{ steps.setup.outputs.bin_name }}
          dist-dir: ${{ steps.setup.outputs.dist_dir }}
          dry-run: ${{ steps.setup.outputs.dry_run }}

      - name: Verify outputs
        run: |
          echo "uploaded-count=${{ steps.upload.outputs.uploaded-count }}"
          echo "upload-error=${{ steps.upload.outputs.upload-error }}"
          [[ "${{ steps.upload.outputs.uploaded-count }}" -gt 0 ]]
          [[ "${{ steps.upload.outputs.upload-error }}" == "false" ]]
